name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  # ── Job 1: validate compose file syntax ─────────────────────────────────────
  validate-compose:
    name: Validate compose config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env from example
        run: cp .env.example .env

      - name: Inject a test root password
        run: |
          sed -i 's|change-me-to-a-strong-random-password|ci-test-password-123|' .env

      - name: Validate docker compose config
        run: docker compose config

  # ── Job 2: smoke test — start MySQL and verify it accepts connections ────────
  smoke-test:
    name: Smoke test (MySQL up + ping)
    runs-on: ubuntu-latest
    needs: validate-compose

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env
        run: |
          cp .env.example .env
          sed -i 's|change-me-to-a-strong-random-password|ci-test-password-123|' .env

      - name: Start MySQL
        run: docker compose up -d

      - name: Wait for MySQL to be healthy
        run: |
          echo "Waiting for MySQL health check to pass …"
          for i in $(seq 1 30); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' mysql8 2>/dev/null || echo "starting")
            echo "  attempt ${i}/30 — status: ${STATUS}"
            if [[ "${STATUS}" == "healthy" ]]; then
              echo "MySQL is healthy."
              break
            fi
            if [[ "${i}" -eq 30 ]]; then
              echo "ERROR: MySQL did not become healthy in time."
              docker compose logs mysql
              exit 1
            fi
            sleep 3
          done

      - name: Ping MySQL
        run: |
          docker compose exec -T mysql \
            mysqladmin ping -h 127.0.0.1 --silent

      - name: Check version
        run: |
          docker compose exec -T mysql \
            mysql -u root -pci-test-password-123 --silent \
            -e "SELECT VERSION();"

      - name: Check charset defaults
        run: |
          docker compose exec -T mysql \
            mysql -u root -pci-test-password-123 --silent \
            -e "SHOW VARIABLES LIKE 'character_set_server';"

      - name: Tear down
        if: always()
        run: docker compose down -v
